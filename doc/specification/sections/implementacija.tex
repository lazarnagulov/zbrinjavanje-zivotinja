\lstset{language=C++,
        basicstyle=\ttfamily,
        frameshape={}{yy}{}{},
        breaklines=true,
        postbreak=\raisebox{0ex}[0ex][0ex]{\ensuremath{\color{gray}\hookrightarrow\space}},
        morekeywords={string, AnimalType, readonly, IReadOnlyCollection, Photo, List, where, interface, Account, get, set},
        keywordstyle=\color{blue}\ttfamily,
        stringstyle=\color{red}\ttfamily,
        commentstyle=\color{green}\ttfamily,
        morecomment=[l][\color{magenta}]{\#}
}
\rhead{10. Implementacija}
\section{Implementacija}
\par Implementacija je javno dostupna na githubu: 
\begin{center}
    https://github.com/lazarnagulov/zbrinjavanje-zivotinja
\end{center}
\subsection{Primena MVVM šablona}
\par Za razvoj je korišćen \textbf{MVVM} (Model-View-ViewModel) arhitektonski obrazac. 
\subsubsection*{Model}
\par \textbf{Model} čine \textbf{entiteti}, \textbf{servisi} i \textbf{repozitorijumi}. 
\par Entiteti su strukture podataka koje, pored samih podataka, sadrže pomoćne funkcije za upravljanje sa konteinerima. 
\par Na primeru [Listing \ref{list:animal}], klasa \textit{Animal} sadrži listu fotografija i pomoćne funkcije za dodavanje, brisanje i dobavljanje
readonly liste.
\begin{lstlisting}[caption={Primer entiteta}, captionpos=b, label=list:animal]
public class Animal(AnimalType type, string name, int age, string description)
{
    public AnimalType Type { get; set; } = type;
    public string Name { get; set; } = name;
    public int Age { get; set; } = age;
    public string Description { get; set; } = description;
    private readonly List<Photo> _photos = [];
    public IReadOnlyCollection<Photo> Photos 
        => _photos;

    public void AddPhoto(Photo photo) 
        => _photos.Add(photo);
    public void RemovePhoto(Photo photo) 
        => _photos.Remove(photo);
}
\end{lstlisting}
\par Servisi: todo
\par Repozitoriju služi za perzistenciju podataka. Najosnovnije operacije nad \textit{entitetima} u bazi podataka su \textbf{CRUD} (create, read, update, delete) 
operacije, koje se nalaze u \textit{ICrud$<$T$>$} intefejsu, prikazanom na listingu \ref{list:crud}.
\begin{lstlisting}[caption={ICrud$<$T$>$ interfejs}, captionpos=b, label={list:crud}]
public interface ICrud<T> where T : class
{
    List<T> GetAll();
    T? GetById(Guid id);
    bool Insert(T entity);
    bool Delete(T entity);
}
\end{lstlisting}
\par Detaljnije o samoj perzistenciji podataka se nalazi u narednoj sekciji.
\subsection{Perzistencija podataka}
\par Za perzistenciju podataka je korišćena PostgresSQL relaciona baza podataka. U nastavku je opisan način na koji smo kreirali bazu podataka (migracijom)
i kreirali validaciju. Na kraju je dat primer funkcionisanja manjeg dela sistema za perzistenciju podataka.
\subsubsection*{Migracija}
\par Migracija je urađena pomoću \textbf{Entity} radnog okvira komandama:
\begin{lstlisting}[caption={Kreiranje migracije}, captionpos=b]
dotnet ef migrations add Initial
dotnet ef database update
\end{lstlisting}
\par Alat automatski generiše C\# kod koji predstavlja promene u modelu i kako te promene treba primeniti na bazu podataka. Neke detalje je moguće podesi preko 
koda, poput \textit{unique} ograničenja, prikazanom na listingu \ref{list:unique} ili preko anotacija [Listing \ref{list:annot}]. 
\begin{lstlisting}[caption={Primer postavljanja unique ograničenja}, label=list:unique, captionpos=b]
modelBuilder.Entity<Account>()
    .HasIndex(account => account.Email)
    .IsUnique();

modelBuilder.Entity<Account>()
    .HasIndex(account => account.Username)
    .IsUnique();
\end{lstlisting}
\begin{lstlisting}[caption={Primer postavljanja anotacija}, label=list:annot, captionpos=b]
[Column("username")]
[Required]
[MaxLength(30)]
public string Username { get; set; }
\end{lstlisting}
\subsection*{Konekcija}
\par Da bi smo se uspešno povezali na bazu, moramo uneti parametre konekcije [Listing \ref{list:params}]. Parametri se učitavaju iz
\textbf{user-secrets} json datoteke, a pristupa im se pomoću klase \textit{Configuration}.
\begin{lstlisting}[caption={Parametri konekcije}, captionpos=b, label={list:params}]
public string Host { get; }
public int Port { get; }
public string Username { get; }
public string Password { get; }
public string Database { get; }
\end{lstlisting}
\par Primer \textit{user-secret}-a se nalazi na listingu \ref{list:user-secret}.
\begin{lstlisting}[caption={Primer \textit{user-secret}}, captionpos=b, label={list:user-secret}]
{
    "Database": {
        "Host": "localhost",
        "Port": 5432,
        "DatabaseName": "PetCenter",
        "Username": "postgres",
        "Password": "1234"
    }
}
\end{lstlisting}
\par Konekciju uspostavljamo \textbf{UseNpgsql} metodom:
\begin{lstlisting}[caption={Uspostavljanje konekcije}, captionpos=b]
optionsBuilder.UseNpgsql(databaseCredentials.ConnectionString);
\end{lstlisting}
\subsubsection*{Validacija}
\par Validacija na nivou baze podataka je pisana u \textbf{SQL}-u. Najčešće korišćen
vid validacije je \textbf{BEFORE INSERT/UPDATE TRIGGER}, koji nam omogućava da, pre samog upisa podataka, proverimo njihovu validnost.
\subsection{Orgnizacija foldera}